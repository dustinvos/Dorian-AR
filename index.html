<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dorian Gray AR</title>

    <!-- iOS Safari viewport fix -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <!-- MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
      }
      a-scene {
        position: fixed !important;
        top: 0; left: 0;
        width: 100vw !important;
        height: 100vh !important;
      }
      /* Enhanced logger with more space */
      #log {
        position: fixed;
        left: 12px;
        bottom: 12px;
        z-index: 99999;
        background: rgba(0,0,0,0.85);
        color: lime;
        padding: 12px;
        font: 11px/1.4 monospace;
        border-radius: 8px;
        max-width: 90vw;
        max-height: 200px;
        overflow-y: auto;
      }
      /* Tap-to-start overlay */
      #startUI {
        position: fixed;
        inset: 0;
        z-index: 99998;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.88);
        color: #fff;
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 24px;
      }
      #startUI button {
        margin-top: 16px;
        font-size: 18px;
        padding: 12px 18px;
        border-radius: 12px;
        border: 0;
        cursor: pointer;
        background: #4CAF50;
        color: white;
      }
    </style>
  </head>

  <body>
    <!-- Tap-to-start UI -->
    <div id="startUI">
      <div>
        <div style="font-size:22px; margin-bottom:10px;">Tap to start AR</div>
        <div style="font-size:14px; opacity:0.85;">
          Allow camera access, then point at the rose marker.
        </div>
        <button id="startBtn">Start</button>
      </div>
    </div>

    <div id="log">Initializing...</div>

    <a-scene
      id="scene"
      mindar-image="imageTargetSrc: targets.mind; autoStart: false;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true"
      embedded
    >
      <a-assets>
        <img id="overlay" src="rose.png" />
        <audio id="audio" src="Dorian_Gray_Chapter_1_Setting.mp3"></audio>
      </a-assets>

      <!-- MindAR camera entity -->
      <a-entity mindar-image-camera="enabled: true"></a-entity>

      <!-- ROSE TARGET -->
      <a-entity mindar-image-target="targetIndex: 0">
        <!-- IMAGE OVERLAY -->
        <a-plane src="#overlay" position="0 0 0" height="1" width="1" opacity="0.9"></a-plane>

        <!-- AUDIO -->
        <a-sound src="#audio" autoplay="true"></a-sound>

        <!-- DEBUG BOX -->
        <a-box position="0 0 0.1" depth="0.05" height="0.2" width="0.2" color="red"></a-box>
      </a-entity>
    </a-scene>

    <script>
      const logEl = document.getElementById('log');
      const startUI = document.getElementById('startUI');
      const startBtn = document.getElementById('startBtn');
      const sceneEl = document.getElementById('scene');

      let logMessages = [];
      const log = (msg) => { 
        console.log(msg);
        const timestamp = new Date().toLocaleTimeString();
        logMessages.push(`[${timestamp}] ${msg}`);
        if (logMessages.length > 10) logMessages.shift();
        logEl.innerHTML = logMessages.join('<br>');
      };

      log("Page loaded");

      // Check if scene loaded
      sceneEl.addEventListener('loaded', () => {
        log("A-Frame scene loaded");
      });

      // MindAR lifecycle messages
      sceneEl.addEventListener("arReady", () => {
        log("âœ“ AR ready - point at rose");
      });
      
      sceneEl.addEventListener("arError", (e) => {
        log("âœ— AR error: " + (e.detail?.error || "unknown"));
        console.error("AR Error details:", e);
      });

      // Target found/lost events
      const targetEntity = document.querySelector('[mindar-image-target]');
      if (targetEntity) {
        targetEntity.addEventListener('targetFound', () => {
          log("ðŸŽ¯ Rose target found!");
        });
        targetEntity.addEventListener('targetLost', () => {
          log("Target lost");
        });
      }

      // Start AR with detailed error handling
      startBtn.addEventListener('click', async () => {
        try {
          log("User clicked Start");
          log("Hiding start UI...");
          startUI.style.display = "none";
          
          log("Requesting camera access...");
          const mindarSystem = sceneEl.systems["mindar-image-system"];
          
          if (!mindarSystem) {
            throw new Error("MindAR system not found");
          }
          
          log("Starting MindAR...");
          await mindarSystem.start();
          
          log("âœ“ AR started successfully");
          
          // Check if camera stream is visible
          setTimeout(() => {
            const video = document.querySelector('video');
            if (video) {
              log(`Video element found: ${video.videoWidth}x${video.videoHeight}`);
              if (video.videoWidth === 0) {
                log("âš  Camera stream not rendering");
              }
            } else {
              log("âš  No video element found");
            }
          }, 1000);
          
        } catch (e) {
          log("âœ— Start failed: " + e.message);
          console.error("Full error:", e);
          alert("AR failed to start: " + e.message);
        }
      });

      // Additional debugging
      window.addEventListener('error', (e) => {
        log("JS Error: " + e.message);
      });
    </script>
  </body>
</html>
